<!DOCTYPE html>
<html>
<head lang="en">
  <title>ONC Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="oncdialogstylesheet.css">
  <script src="editprofile.js"></script>
  <script src="jquery.js"></script>
  <script src="staticcharts.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>  
  <script>
    $( document ).ready(function()
    {
    	//get the list of years from the data base and put it in the year combo box
   	 	var dbyearsparams = "callback=?";
   	 	$.getJSON('dbStatus', dbyearsparams, function(data)
    		{
				var yearCombo = document.getElementById('yearlist');
    			for (var i = data.length-1; i >= 0; i--)
    			{
    				var option = document.createElement('option');
    				option.text = data[i].id;
    	   		 	option.value = data[i].id;

    	    			try 
	    			{
	        			yearCombo.add(option, null); //Standard 
	    			} 
	    			catch(error) 
	    			{
	        			yearCombo.add(option); // IE only
	    			}
    			}
 
    			sessionStorage.setItem('curryear', yearCombo.value);
    			
    			google.charts.load('current', {packages: ['corechart', 'bar']});
            	google.charts.setOnLoadCallback(drawFamStatusChart);
            
            	$.getJSON('getstatus', dbyearsparams, function(status)
            	{
            		if(status.userstatus === 'Update_Profile')
            		{
        				showEditProfileDialog();
        				window.location=document.getElementById('editprofileanchor').href;
            		}
            	});
    		});

//  		window.setInterval(drawFamStatusChart, 300000);	//five minutes
    	});

    function drawFamStatusChart() 
    {
    		var familyparams = "year=" + sessionStorage.getItem('curryear')
		   				+"&maptype=family" + "&callback=?";
    	
   	 		var giftparams = "year=" + sessionStorage.getItem('curryear')
						+"&maptype=gift" + "&callback=?";
    	
    		var mealparams = "year=" + sessionStorage.getItem('curryear')
						+"&maptype=meal" + "&callback=?";
    	
    		var delparams = "year=" + sessionStorage.getItem('curryear')
						+"&maptype=delivery" + "&callback=?";

    		$.getJSON('metrics', familyparams, function(familyData)
        {
    			if(familyData.hasOwnProperty('error'))
				window.location=document.getElementById('timeoutanchor').href;
    			else
    			{	
    				// Create our data table out of JSON data loaded from server.
    	    		var famtable = new google.visualization.DataTable(familyData);
    	 			var famview = new google.visualization.DataView(famtable);
        			famview.setColumns([0, 1,
                          	{ calc: "stringify",
                              sourceColumn: 1,
                           	  type: "string",
                              role: "annotation" },
                            ]);

    				var famoptions = 
    				{
    					width: 480,
    					height: 240,
    					title: sessionStorage.getItem('curryear') + ' Family Status',
    					titleTextStyle: 
    					{
    						fontSize: 16, // 12, 18 whatever you want (don't specify px)
    		        		bold: true,    // true or false
    					},
    	    			chartArea: {width: '70%'},
    	    			hAxis: { minValue: 0 },
    	    			legend: {position: 'none'},
    	    			bars: 'horizontal' // Required for Material Bar Charts.
    				};
    	
    				var famstatuschart = new google.visualization.BarChart(document.getElementById('famstatus_div'));
    				famstatuschart.draw(famview, famoptions);
    			}
    		
    			$.getJSON('metrics', giftparams, function(giftData)
    			{
    		    		// Create our data table out of JSON data loaded from server.
    		    		var gifttable = new google.visualization.DataTable(giftData);
    		    		var giftview = new google.visualization.DataView(gifttable);
    		    		giftview.setColumns([0, 1,
    		    		             { calc: "stringify",
    		    		              	sourceColumn: 1,
    		    		                type: "string",
    		    		                role: "annotation"
    		    		             }]);

    		    		var giftoptions = 
    		    		{
    		    			width: 480,
    		    			height: 240,
    		    			title: sessionStorage.getItem('curryear') + ' Gift Status',
    		    			titleTextStyle: 
        				{
        		        		fontSize: 16, // 12, 18 whatever you want (don't specify px)
        		        		bold: true,    // true or false
        				},
    		    			chartArea:
    		    			{
    		    				width: '65%'
    		    			},
    		    			hAxis: { minValue: 0 },
    		    			legend: {position: 'none'},
    		    		};
    		    		    	
    		    		var giftstatuschart = new google.visualization.BarChart(document.getElementById('giftstatus_div'));
    		    		giftstatuschart.draw(giftview, giftoptions);
    		    
    		    		$.getJSON('metrics', mealparams, function(mealData)
    		    		{
    		    			// Create our data table out of JSON data loaded from server.
    		    			var mealtable = new google.visualization.DataTable(mealData);
    		    			var mealview = new google.visualization.DataView(mealtable);
    		    			mealview.setColumns([0, 1,
    		                 		{ 
    		    							calc: "stringify",
    		                   			sourceColumn: 1,
    		    							type: "string",
    		                   			role: "annotation"
    		                 		}]);

    		    			var mealoptions = 
    		    			{
    		    				width: 480,
    		    				height: 240,
    		    				title: sessionStorage.getItem('curryear') + ' Meal Status',
    		    				titleTextStyle: 
    	    					{
    	    		        			fontSize: 16, // 12, 18 whatever you want (don't specify px)
    	    		        			bold: true,    // true or false
    	    					},
    		    				chartArea: {width: '65%'},
    		    				hAxis: { minValue: 0 },
    		    				legend: {position: 'none'},
    		    			};
    		    	
    		    			var mealstatuschart = new google.visualization.BarChart(document.getElementById('mealstatus_div'));
    		    			mealstatuschart.draw(mealview, mealoptions);
    		    	
    		    			$.getJSON('metrics', delparams, function(delData)
    		    			{
    		    				// Create our data table out of JSON data loaded from server.
    		    				var deltable = new google.visualization.DataTable(delData);
    		    				var delview = new google.visualization.DataView(deltable);
    		    				delview.setColumns([0, 1,
    		    	         				{ 
    		    							calc: "stringify",
    		    	           				sourceColumn: 1,
    		    							type: "string",
    		    	           				role: "annotation"
    		    	         				}]);

    		    				var deloptions = 
    		    				{
    		    					width: 480,
    		    					height: 240,
    		    					title: sessionStorage.getItem('curryear') + ' Gift Delivery Status',
    		    					titleTextStyle: 
    		    					{
    		    		        			fontSize: 16, // 12, 18 whatever you want (don't specify px)
    		    		        			bold: true,    // true or false
    		    					},
    		    					chartArea: {width: '65%'},
    		    					hAxis: { minValue: 0 },
    		    					legend: {position: 'none'},
    		    				};

    		    				var delstatuschart = new google.visualization.BarChart(document.getElementById('delstatus_div'));
    		    				delstatuschart.draw(delview, deloptions);
    		    			});
    		    		});
    			});
        });   			
    }
    
    function onChangePW() 
    {
    	if(validate())
   	 	{
			var params = {}	
			params["field1"] = document.getElementById('currpw').value;
			params["field2"] = document.getElementById('newpw').value;
    		$.post('reqchangepw', params, function(response)
    		{
    			document.getElementById('banner-message').textContent= response;
    			document.getElementById('welcome-div').style.display = "block";
    		});
    		
    		document.getElementById('currpw').value = "";
	    	document.getElementById('newpw').value = "";
	    	document.getElementById('verifypw').value = "";
    		window.location=document.getElementById('closepopup').href;
    	}
    }
    
	function updateForYearSelection()
    {
    	//get selected year
    	var yearCB = document.getElementById("yearlist");
		var year = yearCB.options[yearCB.selectedIndex].value;
		sessionStorage.setItem('curryear', year);
		drawFamStatusChart();
    }

	function onProfileNotChanged()
    {
		var params = {}	
		$.post('profileunchanged', params, function(response)
		{
			document.getElementById('message').textContent= response.message;
		}, "jsonp");
		
		window.location=document.getElementById('closepopup').href;
    }
	
	function onCancel()
    {
		window.location=document.getElementById('closepopup').href;
    }
	
	function validate()
    {
		var mssgEl = document.getElementById("pw_mssg");
    		var currpwEl = document.getElementById("currpw");
        var pass1El = document.getElementById("newpw");
        var pass2El = document.getElementById("verifypw");
        var ok = true;
        
        if(currpwEl.value == "")
        {
        	//alert("current password field empty");
            currpwEl.style.borderColor = "#E34234";
            
            mssgEl.style.color = "Red";
            mssgEl.textContent = "Current password not provided, please try again!";
            ok = false;
        }
        else if(pass1El.value == '' || pass2El.value == '')
    		{
    			//alert("Either New or Verify Passwords are empty");
        		pass1El.style.borderColor = "#E34234";
        		pass2El.style.borderColor = "#E34234";
        
        		mssgEl.style.color = "Red";
        		mssgEl.textContent = "Please fill out both New and Confirm, try again!";
        		ok = false;
    		}
        else if(pass1El.value !== pass2El.value)
        {
            //alert("New and Verify Passwords do not match");
            pass1El.style.borderColor = "#E34234";
            pass2El.style.borderColor = "#E34234";
            
            mssgEl.style.color = "Red";
            mssgEl.textContent = "New and Verify passwords don't match, please try again!";
            ok = false;
        }

        return ok;
    }
	
	function onLogoutLink()
	{
		var params = {};
		post('logout', params);
	}
	
	function onSessionTimeout()
	{
		 window.location.assign('timeout');
	}
	
	function post(path, params, method) 
	{
	    method = method || "post"; // Set method to post by default if not specified.

	    // The rest of this code assumes you are not using a library.
	    // It can be made less wordy if you use one.
	    var form = document.createElement("form");
	    form.setAttribute("method", method);
	    form.setAttribute("action", path);

	    for(var key in params) 
	    {
	        if(params.hasOwnProperty(key)) 
	        {
	            var hiddenField = document.createElement("input");
	            hiddenField.setAttribute("type", "hidden");
	            hiddenField.setAttribute("name", key);
	            hiddenField.setAttribute("value", params[key]);

	            form.appendChild(hiddenField);
	         }
	    }

	    document.body.appendChild(form);
	    form.submit();
	}
  </script>
  <style type="text/css">
  .header 
	{
		height: 70px;
		width: 90% ;
		margin: auto;
		background-color: #484e78;
	}
	.header-links
	{
		display: inline-block;
    	margin-top: 25px;   
	}
	.header-links a
	{
		font-size: 18px;
		margin-right: 40px;
		text-decoration: none;
	}
	.home-link
	{
		color: white;
		font-style: italic;
	}
	.page-link { color: white; }
	.page-link:hover { background-color: #bbb7ff; }
	#logo-img
	{
		vertical-align: middle;
    	margin-top: -8px;
    	margin-left: 5px;
    	margin-right: 10px;
    	max-height: 55px;
    	max-width: 75px;
	}
	.headerbuttons
	{
		display: inline-block;
		float: right;
		margin-top: 22px;
	}
	/* Dropdown Button */
	.dropbtn 
	{
  		color: white;
  		font-size: 16px;
  		background-color: Transparent;
  		background-repeat:no-repeat;
  		border: none;
  		cursor:pointer;
  		overflow: hidden;
  		outline:none;
	}
	.dropdown 
	{
  		position: relative;
  		display: inline-block;
	}
	.dropdown-content
	{
 		display: none;
  		position: absolute;
  		background-color: #f1f1f1;
  		min-width: 160px;
  		box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
 		 z-index: 1;
	}
	.dropdown-content a
	{
  		color: black;
  		padding: 12px 16px;
  		text-decoration: none;
  		display: block;
	}
	.dropdown-content a:hover { background-color: #bbb7ff; }
	.dropdown:hover .dropdown-content { display: block; }
	.dropdown:hover .dropbtn { background-color: #bbb7ff; }
	.header-anchor { text-decoration: none;}
	.floatleft { float:left; }
	.floatright { float:right; }	
	#logoutbtn
	{
		color: white;
		font-size: 16px;
  		background-color: Transparent;
  		background-repeat:no-repeat;
  		border: none;
  		cursor:pointer;
	}
	#logoutbtn:hover  {background-color: #bbb7ff;}
	#welcome-div
	{
		width: 90%;
		height: 36px;
		line-height: 36px;
		margin-top: -8px;
		margin-right: auto;
		margin-left: auto;
		background-color: black;
		display: SHOW_MESSAGE;
	}
	#welcome-div p
	{
		color: white;
		font-size: 18px;
		font-style: italic;
		padding-left: 8px;
	}
	#filterspan
	{
		display: inline-block;
    	margin-left: 10px;
	}
	select 
	{
		display: ck;
		vertical-align: middle;
		width: auto;
		font-size: 12px;
		font-family: sans-serif;
		font-weight: 700;
		color: #444;
		line-height: 1.3;
		padding: .6em 1.4em .5em .8em;
		max-width: 100%;
		box-sizing: border-box;
		margin: 0;
		border: 1px solid #aaa;
		box-shadow: 0 1px 0 1px rgba(0,0,0,.04);
		border-radius: .5em;
		-moz-appearance: none;
		-webkit-appearance: none;
		appearance: none;
		background-color: #fff;		
		background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'),linear-gradient(to bottom, #ffffff 0%,#e5e5e5 100%);
		background-repeat: no-repeat, repeat;
		background-position: right .7em top 50%, 0 0;
		background-size: .65em auto, 100%;
	}
	select::-ms-expand { display: none; }
	select:hover { border-color: #888; }
	select-css:focus 
	{
		border-color: #aaa;
		box-shadow: 0 0 1px 3px rgba(59, 153, 252, .7);
		box-shadow: 0 0 0 3px -moz-mac-focusring;
		color: #222;
		outline: none;
	}
	select option { font-weight: normal; }
	.filterlabel
	{
		display: inline-block;
		margin-left: 6px;
    	margin-right: 6px;
		font-size: 18px;
	}
	form
	{
		width:90%;
		min-width: 900px;
		margin: 0 auto;
		border: none;
	}
	fieldset 
	{
		margin-top: 5px;
		background-color: #E8E8E8;
	}
	legend
	{
  		padding: 0.2em 0.5em;
  		border:1px solid black;
  		background-color: #E8E8E8;
  		font-size:80%;
  		text-align:left;
	}	
	.constrainer 
    {
        width: 90%;
		margin: 0 auto;
    }
    table
    {
    	margin-top: 12px;
    	margin-right: auto;
    	margin-bottom: 0px;
    	margin-left: auto;
    }
    td
    {
  		padding: 10px;
  		background-color: #E8E8E8;
  		border-color: black;
  		border-width: 2px;
  		border-style: ridge;
	}
    table, td
    {
    	border-color: black;
    	border-width: 2px;
    	border-style: ridge;
    }
  </style>
</head>
<body>
  <a href="#editProfile" id="editprofileanchor" style="visibility: hidden">Edit Profile</a>
  <a href="#timeoutdlg" id="timeoutanchor" style="visibility: hidden">Timeout</a>
  <div class='header'>
    <img id='logo-img' src="onclogo">
    <span class='header-links'>
      <a class='home-link' href='#'>Dashboard</a>
      <a class='page-link' href="familystatus">Families</a>
      <a class='page-link' href="partnertable">Partners</a>
      <a class='page-link' href="regiontable">Regions</a>
    </span>   
    <div class='headerbuttons'>
      <div class='dropdown'>
        <button class=dropbtn>Profile</button>
        <div class='dropdown-content'>
      	  <a href="#editProfile" onclick='showEditProfileDialog()'>Edit Profile</a>
      	  <a href="#chgpwdlg">Change Password</a>
      	</div> 
      </div>
      <button id='logoutbtn' onclick='onLogoutLink()'>Logout</button>
    </div>
  </div>
  <div id="welcome-div">
    <p id='banner-message'>BANNER_MESSAGE<p>
  </div>
  <form>
  	<fieldset>
  		<legend>Filters</legend>
		<span id='filterspan'>
		  <label for='yearlist' class='filterlabel'>Season:</label>
		  <select id="yearlist" name="yearlist" onchange="updateForYearSelection()"></select>
		</span>  
	</fieldset>		
  </form>    
  <!--Table and divs that hold the charts-->
  <div class="constrainer">
    <table>
      <tr>
        <td><div id="famstatus_div"></div></td>
        <td><div id="giftstatus_div"></div></td>
      </tr>
      <tr>
        <td><div id="mealstatus_div"></div></td>
        <td><div id="delstatus_div"></div></td>
      </tr>
    </table>
  </div>
<!-- Edit Profile Dialog -->
  <div id="editProfile" class="modalDialog">
	  <div class='innerextended'>
		<div class='dialogtopbar'>
		  <img class='logoimg' src="onclogo">
		  <span class='logospan'>Verify/Update ONC Profile</span>
	  </div>
	  <div class='greenbackground'>
	  <fieldset class="fieldset-auto-width">
  		<legend class="legend-major">Contact Information</legend>
  		<div class= 'profilediv'>
    	  		<label for="userfirstname">Name:</label>
    	  		<input id='userfirstname' type="text" size="16" placeholder="First Name" onchange='checkForProfileChange()'>
    	  		<input id='userlastname' type="text" size="16" placeholder="Last Name" onchange='checkForProfileChange()'>
    	  	</div>
    	  	<div class= 'profilediv'>
    	  		<label for="userorg" >Organization:</label>
    	  		<input id='userorg' type="text" size="28" placeholder="Organization" onchange='checkForProfileChange()'>
    	  	</div>
    	  	<div class= 'profilediv'>
    	  		<label for="usertitle" >Title:</label>
    	  		<input id='usertitle' type="text" size="33" placeholder="Title" onchange='checkForProfileChange()'>
    	  	</div>
    	  	<div class= 'profilediv'>
    	  		<label for="useremail" >Email:</label>
    	  		<input id='useremail' type="text" size="35" placeholder="Email address" onchange='checkForProfileChange()'>
    	  	</div>
    	  	<div class= 'profilediv'>
    	  		<label for="userphone" >Phone:</label>
    	  		<input id='userphone' type="text" size="22" placeholder="Work Phone #" onchange='checkForProfileChange()'>
    	  	</div>
    	  </fieldset>
    	  </div>
    	  <div class='greenbackground'>
    	  <fieldset class="fieldset-auto-width">
    	  <legend class="legend-major">Your School(s) or Organization(s)</legend>
  	    <table id="grouptable">
  		  <thead>
    			<tr>
        			<th width='320px' >School or Organization</th>
        			<th class='onccol'>Action</th>
    			</tr>
    		  </thead>
    		  <tbody id="grouptbody">
    		  </tbody>
	    </table>
	    <div class='profilediv'> 
  		  <select id="groupselect" title="School or Organization Name" oninput='onGroupSelected(this)'></select>
  		  <button id='addgroup' value='unchanged' type="button" onclick="addGroup()" style="background-color:Grey" title="Click to add school or organization" disabled>Add School/Org.</button>
  		</div>
  </fieldset>
  </div>
    	  <div id='buttonbar'>
    	    <button id="cancel" onclick="onProfileNotChanged()">No Change</button>
        <button id="update" value='unchanged' style="background-color:Grey" onclick="onUpdateProfile(this)" disabled>Update</button>
    	  </div> 
	</div>
  </div>
<!-- Change Password Dialog -->
  <div id="chgpwdlg" class="modalDialog">
	<div class='inner'>
		<a id='closepopup' href="#close" title="Close" class="close">X</a>
		<div class='dialogtopbar'>
		  <img class='logoimg' src="onclogo">
		  <span class='logospan'>Change Password</span>
		</div>
		<p id='pw_mssg'>Enter current and new password:</p>
    	<p><label class='lbl_pw' for="currpw">Current Password:</label>
    	<input class='inp_pw' type="password" id="currpw" name="field1" autofocus></p>
    	<p><label class='lbl_pw' for="newpw">New Password:</label>
    	<input class='inp_pw' type="password" id="newpw" name="field2"><br></p>
    	<p><label class='lbl_pw' for="verifypw" >Verify Password:</label>
    	<input class='inp_pw' type="password" id="verifypw" name="field3"></p>
    	<div id='buttonbar'>
      	  <button id="cancel" onclick="onCancel()">Cancel</button>
      	  <button id="submit" onclick="onChangePW()">Change Password</button>
    	</div> 
	</div>
  </div>
  <!-- Timeout Dialog -->
  <div id="timeoutdlg" class="modalDialog">
	<div id='inner'>
		<div class='dialogtopbar'>
		  <img class='logoimg' src="onclogo">
		  <span class=logospan id="successfamheader">Session Timeout</span>
		</div>
		<p id='to_mssg'>Your session expired due to inactivity</p>
    	<div id='buttonbar'>
      	  <button id="submit" onclick="onSessionTimeout()">Logout</button>
    	</div> 
	</div>
  </div>   
</body>
</html>