<!DOCTYPE html>
<html>
<head lang="en">
  <title>ONC Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="oncnewstylesheet.css">
  <script src="staticcharts.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/v/dt/jq-3.3.1/jszip-2.5.0/dt-1.10.20/b-1.6.1/b-html5-1.6.1/r-2.2.3/sc-2.0.1/sl-1.3.1/datatables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.20/api/sum().js"></script>
  <script type="text/javascript" src="onccommon.js"></script>  
  <script>
    $( document ).ready(function()
    {
    	//get filter selects
    	filters = document.getElementById('filterspan').getElementsByTagName('select');
    	
    	//get the list of years from the data base and put it in the year combo box
   	 	var dbyearsparams = "callback=?";
   	 	$.getJSON('dbStatus', dbyearsparams, function(data)
    	{
			var yearCombo = document.getElementById('curryear');
    		for (var i = data.length-1; i >= 0; i--)
    		{
    			var option = document.createElement('option');
    			option.text = data[i].id;
    	   		option.value = data[i].id;
    	   		try 
	    		{
	        		yearCombo.add(option, null); //Standard 
	    		} 
	    		catch(error) 
	    		{
	        		yearCombo.add(option); // IE only
	    		}
    		}
    			
    		if(sessionStorage.getItem('curryear') == null)
            {
            	yearCombo.selectedIndex = 0;
            	sessionStorage.setItem('curryear', yearCombo.value);
            }
            else
            	yearCombo.value = sessionStorage.getItem('curryear');	
 
    		document.getElementById('resetbtn').disabled = yearCombo.selectedIndex == 0;
    			
    		google.charts.load('current', {packages: ['corechart', 'bar']});
            google.charts.setOnLoadCallback(drawStatusCharts);
            
            $.getJSON('getstatus', dbyearsparams, function(status)
            {
            	if(status.userstatus === 'Update_Profile')
            	{
        			showEditProfileDialog();
        			window.location=document.getElementById('editprofileanchor').href;
            	}
            });
    	});

   	 	createGroupTable();	//create profile dialog group table
//  	window.setInterval(drawStatusCharts, 300000);	//five minutes
    });

    var charts = [{title: 'Family Status', type: 'family', width: '70%', div: 'famstatus_div'},
    			  {title: 'Gift Status', type: 'gift', width: '65%', div: 'giftstatus_div'},
    			  {title: 'Meal Status', type: 'meal', width: '65%', div: 'mealstatus_div'},
    			  {title: 'Delivery Status', type: 'delivery', width: '65%', div: 'delstatus_div'}];
    
    function drawStatusCharts() 
    {
    	var params = "year=" + sessionStorage.getItem('curryear') + "&maptype=" + charts[0].type + "&callback=?";    	
    	$.getJSON('metrics', params, function(data)
        {
    		if(data.hasOwnProperty('error'))
				window.location=document.getElementById('timeoutanchor').href;
    		else
    		{
    			drawChart(charts[0], data);
    			
    			params = "year=" + sessionStorage.getItem('curryear') + "&maptype=" + charts[1].type + "&callback=?";
    			$.getJSON('metrics', params, function(data)
    			{
    				drawChart(charts[1], data);
    				
    				params = "year=" + sessionStorage.getItem('curryear') + "&maptype=" + charts[2].type + "&callback=?";
        			$.getJSON('metrics', params, function(data)
        			{
        				drawChart(charts[2], data);
        				
        				params = "year=" + sessionStorage.getItem('curryear') + "&maptype=" + charts[3].type + "&callback=?";
            			$.getJSON('metrics', params, function(data)
            			{
            				drawChart(charts[3], data);
            			});
        			});
    			});
    		}
        });
    }    			

	function getExternalData()
	{
		drawStatusCharts();
	}

	function drawChart(chart, data)
	{
		// Create our data table out of JSON data loaded from server.
		var table = new google.visualization.DataTable(data);
		var view = new google.visualization.DataView(table);
		view.setColumns([0, 1,
			{
		    	calc: "stringify",
		        sourceColumn: 1,
		        type: "string",
		        role: "annotation"},
		    ]);

		var options = 
		{
		    width: 480,
		    height: 240,
		    title: sessionStorage.getItem('curryear') + ' ' + chart.title,
		    titleTextStyle: 
		    {
		    	fontSize: 16, // 12, 18 whatever you want (don't specify px)
		    	bold: true,    // true or false
		    },
		    chartArea: { width: chart.width},
		    hAxis: { minValue: 0 },
		    legend: { position: 'none'},
//			bars: 'horizontal' // Required for Material Bar Charts.
		};
		    	
		var chart = new google.visualization.BarChart(document.getElementById(chart.div));
		chart.draw(view, options);
	}
  </script>
  <style type="text/css">	
	.header-links a
	{
		color: white;
		font-size: 18px;
		margin-right: 40px;
		text-decoration: none;
	}
	.home-link
	{
		font-style: italic;
	}
	.page-link:hover { background-color: #bbb7ff; }   
    .graph-div 
    {
        width: 90%;	
		margin: 0 auto;	
    }
    .graph-div td
    {
    	border-color: black;
    	border-width: 2px;
    	border-style: ridge;
    	padding: 10px;
    	background-color: #E8E8E8;
    	display: table-cell;
    }
  </style>
</head>
<body>
  <a href="#editProfile" id="editprofileanchor" style="visibility: hidden">Edit Profile</a>
  <a href="#timeoutdlg" id="timeoutanchor" style="visibility: hidden">Timeout</a>
  <div class='header'>
    <img class='logo-img' src="onclogo">
    <span class='header-links'>
      <a class='home-link' href='#'>Dashboard</a>
      <a class='page-link' href="familystatus">Families</a>
      <a class='page-link' href="partnertable">Partners</a>
      <a class='page-link' href="regiontable">Regions</a>
    </span>   
    <div class='headerbuttons'>
      <div class='dropdown'>
        <button class=dropbtn>Profile</button>
        <div class='dropdown-content'>
      	  <a href="#editProfile" onclick='showEditProfileDialog()'>Edit Profile</a>
      	  <a href="#chgpwdlg">Change Password</a>
      	</div> 
      </div>
      <button id='logoutbtn' onclick='onLogoutLink()'>Logout</button>
    </div>
  </div>
  <div id="welcome-div">
    <p id='banner-message'>BANNER_MESSAGE<p>
  </div>
  <form>
  	<fieldset>
  		<legend>Filters</legend>
		<span id='filterspan'>
		  <label for='curryear' class='filterlabel'>Season:</label>
		  <select id="curryear" title="Season" data-type='externaldata' data-column='-1' onchange='executeFilter(this)'></select>
		</span>
		<span class='floatright resetbtn'>
			<button id="resetbtn" onclick='onResetFilters()'>Reset Filters</button>
		</span>  
	</fieldset>		
  </form>    
  <!--Table and divs that hold the charts-->
  <div class="graph-div">
    <table>
      <tr>
        <td><div id="famstatus_div"></div></td>
        <td><div id="giftstatus_div"></div></td>
      </tr>
      <tr>
        <td><div id="mealstatus_div"></div></td>
        <td><div id="delstatus_div"></div></td>
      </tr>
    </table>
  </div>
<!-- Edit Profile Dialog -->
  <div id="editProfile" class="modalDialog">
	<div class='inner extended-width'>
	  <div class='dialogtopbar'>
		<img class='logo-img' src="onclogo">
		<span class='logospan'>Verify/Update ONC Profile</span>
	  </div>
	  <div class='edit-background'>
	  	  <fieldset id='contact-info-fieldset'>
  			  <legend class="legend-major">Contact Information</legend>
  			  <p>
    	  		<label for="userfirstname">Name:</label>
    	  		<input id='userfirstname' type="text" size="14" placeholder="First Name" onchange='checkForProfileChange()'>
    	  		<input id='userlastname' type="text" size="16" placeholder="Last Name" onchange='checkForProfileChange()'>
    		  </p>   		
    		  <p>
    	  		<label for="userorg">Organization:</label>
    	  		<input id='userorg' type="text" size="28" placeholder="Organization" onchange='checkForProfileChange()'>
    	 	  </p>
    	 	  <p>
    	  		 <label for="usertitle">Title:</label>
    	 		 <input id='usertitle' type="text" size="35" placeholder="Title" onchange='checkForProfileChange()'>
    	 	  </p>
    	 	  <p>
    	  		<label for="useremail">Email:</label>
    	  		<input id='useremail' type="text" size="34" placeholder="Email address" onchange='checkForProfileChange()'>
    	      </p>
    	 	  <p>
    	  		<label for="userphone">Phone:</label>
    	  		<input id='userphone' type="text" size="24" placeholder="Work Phone #" onchange='checkForProfileChange()'>
    	  	  </p>
      	  </fieldset>
	  </div>
      <div class='edit-background'>
		<fieldset>
			<legend class="legend-major">Your School(s) or Organization(s)</legend>  	 
  	    	 <table id="profiletable" class='display' style="width:100%">
  		 	  <thead>
    			<tr>
    				<th>Id</th>
        			<th>School or Organization</th>
    			</tr>
    		  </thead>
    		  <tbody>
    		  </tbody>
	    	</table>
	    	<div> 
  		  		<select id="groupselect" title="School or Organization Name" oninput='onGroupSelected(this)'></select>
  			</div>
  		</fieldset>
  	  </div>
      <div id='buttonbar'>
    	<button id="cancel" onclick="onProfileNotChanged()">No Change</button>
        <button id="update" onclick="onUpdateProfile(this)" disabled>Update</button>
      </div> 
	</div>
  </div>
<!-- Change Password Dialog -->
  <div id="chgpwdlg" class="modalDialog">
	<div class='inner regular-width'>
		<a id='closepopup' href="#close" title="Close" class="close">X</a>
		<div class='dialogtopbar'>
		  <img class='logo-img' src="onclogo">
		  <span class='logospan'>Change Password</span>
		</div>
		<p id='pw_mssg'>Enter current and new password:</p>
    	<p><label class='lbl_pw' for="currpw">Current Password:</label>
    	<input class='inp_pw' type="password" id="currpw" name="field1" autofocus></p>
    	<p><label class='lbl_pw' for="newpw">New Password:</label>
    	<input class='inp_pw' type="password" id="newpw" name="field2"></p>
    	<p><label class='lbl_pw' for="verifypw" >Verify Password:</label>
    	<input class='inp_pw' type="password" id="verifypw" name="field3"></p>
    	<div id='buttonbar'>
      	  <button id="cancel" onclick="onCancel()">Cancel</button>
      	  <button id="submit" onclick="onChangePW()">Change Password</button>
    	</div> 
	</div>
  </div>
  <!-- Timeout Dialog -->
  <div id="timeoutdlg" class="modalDialog">
	<div class='inner regular-width'>
		<div class='dialogtopbar'>
		  <img class='logo-img' src="onclogo"/>
		  <span id='dialogmssg'>Session Timeout</span>
		</div>
		<p id='to_mssg'>Your session expired due to inactivity</p>
    	<div id='buttonbar'>
      	  <button id="timeoutsubmit" onclick="onSessionTimeout()">Logout</button>
    	</div> 
	</div>
  </div>  
</body>
</html>