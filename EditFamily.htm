 <!DOCTYPE html>
<html>
<head lang="en">
  <title>ONC Family Contact Info Update</title>
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script> 
	var hohAddressGood = false;
  	var delAddressGood = false;
  	var errorColor = '#FF9999';
  	
  	$( document ).ready(function()
	{
  		//set the hidden values
  		document.getElementById('year').value= new Date().getFullYear().toString();
  		document.getElementById('token').value= sessionStorage.getItem("token");
  		document.getElementById('targetid').value= sessionStorage.getItem("targetid");
  		
  		var urlmode = window.location.href;
  		if(urlmode.indexOf("familyupdate") > -1)
  		{
  			familyparams = "token=" + sessionStorage.getItem("token") + "&" +
  							"year=" + new Date().getFullYear().toString() + "&" +
  							"targetid=" + sessionStorage.getItem("targetid") + "&" +
  							"callback=?";
  			
  			$.getJSON('getfamily', familyparams, function(family)
  			{
  		     	updateFamilyInfo(family);
  		     	verifyHOHAddress();
  		     	verifyDeliveryAddress();
  		     	
  		     	//get meal and update if family meal id > 1
  		     	if(family.mealID > -1)
  		     	{
  		     		var mealparams = "token=" + sessionStorage.getItem("token") + "&" +
  		     						"year=" + new Date().getFullYear().toString() + "&" +
  		     						"mealid=" + family.mealID.toString() + "&" +
  		     						"callback=?";	
  		     					
  		     		$.getJSON('getmeal', mealparams, function(meal)
  		     	  	{
  		     			updateMealRequest(family, meal);
  		     		});
  		     	}
  		     	else
  		     		document.getElementById('mealstatus').value = "None Requested";
  			});
  		}	
  		
  		$(function() {
  		    $("form input").keypress(function (e) {
  		        if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
  		            $('button[type=submit] .default').click();
  		            return false;
  		        } else {
  		            return true;
  		        }
  		    });
  		});
  		
  		$('html').bind('keypress', function(e)
  		{
  			if(e.keyCode == 13)
  			{
  				return false;
  			}
  		});
	});
  	
  	function updateFamilyInfo(family)
  	{		        
  		var familyElements = [family.HOHFirstName, family.HOHLastName, family.Language, family.HouseNum, family.Street, 
  			                    family.UnitNum, family.City, family.ZipCode, family.FamilyEmail, family.details];
  			
  		var formElements = ['hohfn', 'hohln','language', 'housenum', 'street', 'unit', 'city', 'zipcode', 'email', 'detail'];
  			
  		//set name, HoH address, email and detail elements
  		for(var i=0; i<familyElements.length; i++)
  			document.getElementById(formElements[i]).value = familyElements[i];
  	
  		//set phone elements
  		var homephoneParts= family.HomePhone.split(/\r\n|\r|\n/g);
  		document.getElementById('homephone').value = homephoneParts[0];
  		
  		var otherphoneParts= family.OtherPhone.split(/\r\n|\r|\n/g);
  		if(otherphoneParts.length > 1)
  		{
  			document.getElementById('cellphone').value = otherphoneParts[0];
  			document.getElementById('altphone').value = otherphoneParts[1];
  		}
  		else if(otherphoneParts.length === 1)
  			document.getElementById('cellphone').value = otherphoneParts[0];
  			
  		//set delivery adress elements
  		var deliveryAddr = family.substituteDeliveryAddress.split('_');
  		var hohAddrElements = [family.HouseNum, family.Street, family.UnitNum, family.City, family.ZipCode];
  		var delAddrElements = ['delhousenum', 'delstreet', 'delunit', 'delcity', 'delzipcode'];
  		if(deliveryAddr.length === delAddrElements.length)	//delivery address is different
  		{
  			for(var i=0; i<deliveryAddr.length; i++)
  				document.getElementById(delAddrElements[i]).value = deliveryAddr[i];
  		}
  		else	//delivery address is the same
  		{
  			var cb = document.getElementById("checkbox");
  			cb.checked= true;
  			sameAddressClicked(cb);
  		}		
  	}
  	
  	function updateMealRequest(family, meal)
  	{
  		document.getElementById('mealstatus').value = family.mealStatus;
  		document.getElementById('mealtype').value = meal.type;
  		document.getElementById('dietres').value = meal.dietaryRestrictions
  	}
	
  	function sameAddressClicked(cb)
	{
		var addrInputElements = [document.getElementById('housenum'),
				                    document.getElementById('street'),
				                    document.getElementById('unit')];
		
		var addrSelectElements = [document.getElementById('city'),
		                          document.getElementById('zipcode')];
		                          
		var delInputElements = [document.getElementById('delhousenum'),
				                 document.getElementById('delstreet'),
				                 document.getElementById('delunit')];
		
		var delSelectElements = [document.getElementById('delcity'),
		                          document.getElementById('delzipcode')];
		
		if(cb.checked == true)
		{	
			//copy the address input elements to delivery address elements
			for(var i=0; i<addrInputElements.length; i++)
				delInputElements[i].value = addrInputElements[i].value;
			
			delSelectElements[0].value = addrSelectElements[0].value;
			cityChanged('delcity');
			delSelectElements[1].value = addrSelectElements[1].value;
			
			//set read only
			for(var i=0; i<addrInputElements.length; i++)
			{
				delInputElements[i].readOnly = true;
				addrInputElements[i].readOnly = true;
			}
			
			//verify the address
			verifyDeliveryAddress();	
		}
		else
		{
			//clear the delivery address elements
			for(var i=0; i<delInputElements.length; i++)
				delInputElements[i].value = "";
			
			delSelectElements[0].selectedIndex = 0;
			cityChanged('delcity');
			delSelectElements[1].selectedIndex = 0;
		
			//clear read only for delivery input elements
			for(var i=0; i<addrInputElements.length; i++)
			{
				delInputElements[i].readOnly = false;
				addrInputElements[i].readOnly = false;
			}
			
			//clear background color
			changeAddressBackground(delInputElements, '#FFFFFF')
			changeAddressBackground(delSelectElements, '#FFFFFF')
		}
	}
  	
	function cityChanged(elementName)
	{
		if(elementName === 'city')
			var zipElement = document.getElementById('zipcode')
		else
			var zipElement = document.getElementById('delzipcode')	
		for(i = 0; i < zipElement.options.length; i++)
  			zipElement.options[i] = null;
		
		var cityElement = document.getElementById(elementName);

		if(cityElement.value === 'Centreville')
		{
			zipElement.options[0] = new Option('20120', '20120');
			zipElement.options[1] = new Option('20121', '20121');
		}
		else if(cityElement.value === 'Chantilly')
		{
			zipElement.options[0] = new Option('20151', '20151');
		}
		else if(cityElement.value === 'Clifton')
		{
			zipElement.options[0] = new Option('20124', '20124');
		}
		else if(cityElement.value === 'Fairfax')
		{
			zipElement.options[0] = new Option('22033', '22033');
		}
		else if(cityElement.value === 'Fairfax Station')
		{
			zipElement.options[0] = new Option('22039', '22039');
		}
		
		if(elementName === 'city')
			verifyHOHAddress();
		else
			verifyDeliveryAddress();
	}
	function verifyHOHAddress()
	{
		//called when HOH address inputs blur
		var addrElement = [document.getElementById('housenum'), 
		                   document.getElementById('street'),
		                   document.getElementById('unit'),
		                   document.getElementById('city'), 
		                   document.getElementById('zipcode')];
		
		var unitElement = [document.getElementById('unit')];
		
		//check to see that housenum and street are provided
		if(addrElement[0].value !== "" && addrElement[1].value !== "" )
		{
			//form the address url
	        var addressparams = createAddressParams(addrElement);
	        var addrresponse;
	        $.getJSON('address', addressparams, function(data)
	      	{
	      		addresponse = data;
	      		
	      		if(addresponse.errorCode === 0)
	      		{
	      			changeAddressBackground(addrElement, '#FFFFFF');
	      			hohAddressGood = true;
	      		}	
	      		else if(addresponse.errorCode === 1 || addresponse.errorCode === 3)
	      		{
	      			hohAddressGood = false;
	      			changeAddressBackground(addrElement, errorColor);
	      		}
	      		else if(addresponse.errorCode === 2)
	      		{
	      			hohAddressGood = false;
	      			changeAddressBackground(addrElement, '#FFFFFF');
	      			changeAddressBackground(unitElement, errorColor);
	      		}
	      	});
		}
		else
			hohAddressGood = false;
	}
	
	function verifyDeliveryAddress()
	{
		//called when delivery address inputs blur
		var addrElement = [document.getElementById('delhousenum'),
		                   document.getElementById('delstreet'),
		                   document.getElementById('delunit'),
		                   document.getElementById('delcity'), 
		                   document.getElementById('delzipcode')];
		
		var unitElement = [document.getElementById('delunit')];
		
		//check to see that housenum and street are provided
		if(addrElement[0].value !== "" && addrElement[1].value !== "" )
		{
			//form the address url
	        var addressparams = createAddressParams(addrElement);
	        var addrresponse;
	        $.getJSON('address',  addressparams, function(data)
	      	{
	      		addresponse = data;
	      		
	      		if(addresponse.errorCode === 0)
	      		{
	      			changeAddressBackground(addrElement, '#FFFFFF');
	      			delAddressGood = true;
	      		}	
	      		else if(addresponse.errorCode === 1 || addresponse.errorCode === 3)
	      		{
	      			delAddressGood = false;
	      			changeAddressBackground(addrElement, errorColor);
	      		}
	      		else if(addresponse.errorCode === 2)
	      		{
	      			delAddressGood = false;
	      			changeAddressBackground(addrElement, '#FFFFFF');
	      			changeAddressBackground(unitElement, errorColor);
	      		}
	      	});
		}
		else
			delAddressGood = false;
	}
	
	function onZipChanged(zipelement)
	{
		if(zipelement === 'zipcode')
			verifyHOHAddress();
		else
			verifyDeliveryAddress();
	}
	
	function changeAddressBackground(elements, color)
	{
		for(var i=0; i< elements.length; i++)
			elements[i].style.backgroundColor = color;
	}
	function createAddressParams(addrElement)
	{	
		var addressparams = "token=" + sessionStorage.getItem("token") + "&" +
							"prioryear=" + sessionStorage.getItem("prioryear") + "&" +
							"housenum=" + encodeURIComponent(addrElement[0].value) + "&" +
							"street=" + encodeURIComponent(addrElement[1].value) + "&" +
							"unit=" + encodeURIComponent(addrElement[2].value) + "&" +
							"city=" + addrElement[3].value + "&" +
							"zipcode=" + addrElement[4].value + "&" +
							"callback=?";
		
		return addressparams;
	}
	function verifyPhoneNumbers()
	{
		var errorMssg= "";
		
		var phoneName= ["Primary", "Alternate", "2nd Alternate"];
		
//		if(document.getElementById('homephone').value=="")
//		{
//			document.getElementById('homephone').style.backgroundColor= errorColor;
//			errorMssg= "Submission Error: Primary Phone # missing"
//		}
//		else
//		{
			var index=0;
			while(index<phoneName.length && verifyPhoneNumber(index))
				index++;
			
			if(index < phoneName.length)	
				errorMssg= "Submission Error: " + phoneName[index] + " Phone # is invalid";	
//		}
		
		return errorMssg;	
	}
	function verifyPhoneNumber(elementNum)
	{
		var phoneElement= [document.getElementById('homephone'), 
							document.getElementById('cellphone'),
							document.getElementById('altphone')];
		
		var numberGood = true;
		var number= phoneElement[elementNum].value;
		
		if(number == '')
			phoneElement[elementNum].style.backgroundColor = '#FFFFFF';
		else if(number.length===12 && number.charAt(3)==='-' && number.charAt(7)==='-')
			phoneElement[elementNum].style.backgroundColor = '#FFFFFF';
		else if(number.length===12 && number.charAt(3)==='.' && number.charAt(7)==='.')
			phoneElement[elementNum].style.backgroundColor = '#FFFFFF';
		else if(number.length===10 && number.indexOf("-")===-1 && number.indexOf(".")===-1)
			phoneElement[elementNum].style.backgroundColor = '#FFFFFF';
		else
		{
			numberGood= false;
			phoneElement[elementNum].style.backgroundColor = errorColor;
		}
		
		return numberGood;
	}
	function submitUpdate()
	{
		var phoneNumbersGood= true;
		var errorElement = document.getElementById('errormessage');
 
		if(hohAddressGood===false)
			errorElement.textContent = "Submission Error: HoH address incomplete or does not exist";
		else if(delAddressGood===false)
			errorElement.textContent = "Submission Error: Delivery address incomplete or does not exist";
		else
		{	
			//check phone numbers
			var phoneMssg= verifyPhoneNumbers();
			if(phoneMssg != '')
			{
				phoneNumbersGood=false;
				errorElement.textContent=phoneMssg;
			}
		}
		
	    return hohAddressGood && delAddressGood && phoneNumbersGood;
	}
  </script>
  <style>
  	.topbar 
    {
    	width:900px;
    	height:72px;
    	margin:0 auto;
    	background-color: #FF0000;
		border: 1px solid black;
	}
	.topbar img
	{
    	float:left;
   		border: 0;
	}
	div.ui-datepicker
	{
		width:480px;
  		background-color: lightgray;
  		font-size:15px;
	}
	form
	{
		width:900px;
		margin:0 auto;
		background-color: #3CB371;
		border: 1px solid black;
	}
	button
    {
        background-color: #336699;
        color: #ffffff;
    }      
	.major
	{
  		padding: 0.2em 0.5em;
  		border:2px solid black;
/*  		background-color: #E8E8E8;	*/
  		background-color: #E5FFCC;
  		font-size:80%;
  		text-align:left;
  	}
  	#topbar p
    {
       	text-align: center;
    }
    #banner
    {
    	font-weight: bold;
    	font-style: italic;
    	font-size: 130%;
	}
	fieldset {background-color: #E8E8E8;}
	#submitspan {float: right;}
	#errormessage
	{
		float: left;
		font-weight: bold;
		font-style: italic;
		color: red;
	}
	button { background-color: #336699; color: #fffff; }
  </style>
</head>
<body>
  <div id="topbar" class="topbar">
    <img src="onclogo" height="55" width="75"/>
    <p><span id="banner">ONC Family Contact Information Update Form</span><br>
	<span id="message">(please edit and click Submit To ONC to update contact info)</span></p>
  </div>
  <form id="updatefamily" action="updatefamily" onsubmit="return submitUpdate()" method="post">
  <input id='token' type="hidden" name="token">
  <input id="year" type="hidden" name="year">
  <input id='targetid' type="hidden" name="targetid">
  <br>
  <fieldset>
  <legend class="major">Head of Household (HOH) Information</legend>
    <input id="hohfn" title="First Name" name="hohFN" type="text" size="20" placeholder="First Name" value="HOHFN" required>
    <input id="hohln" title="Last Name" name="hohLN" type="text" size="20" placeholder="Last Name", value="HOHLN" required>
    <input id="homephone" title="Home Phone #" name="homephone" type="text" size="18" placeholder="Primary Phone #" onchange="verifyPhoneNumber(0)" required>
    <input id= "cellphone" title="Cell Phone #" name="cellphone" type="text" size="18" placeholder="Alternate Phone #" onchange="verifyPhoneNumber(1)">
    <input id= "altphone" title="Alternate Phone #" name="altphone" type="text" size="18" placeholder="2nd Alt Phone #" onchange="verifyPhoneNumber(2)">
  	<select id="language" title="Primary language" name="language">
		<option value="English">English</option>
		<option value="Spanish">Spanish</option>
		<option value="Arabic">Arabic</option>
		<option value="Korean">Korean</option>
		<option value="Vietnamese">Vietnamese</option>
		<option value="Other">Other</option>
		<option value="?">Unknown</option>
	</select>
	<br>
	<input id="housenum" title="House #" name="housenum" type="text" size="8" placeholder="House #" onchange="verifyHOHAddress()" autocomplete="off" required>
    <input id="street" title="Street Name" name="street" type="text" size="20" placeholder="Street Name" onchange="verifyHOHAddress()" autocomplete="off" required>
    <input id="unit" title="Apt. or Unit #" name="unit" type="text" size="8" placeholder="Apt #" onchange="verifyHOHAddress()" autocomplete="off">
    <select id="city" title="City" name="city" onchange="cityChanged('city')">
		<option value="Centreville">Centreville</option>
		<option value="Chantilly">Chantilly</option>
		<option value="Clifton">Clifton</option>
		<option value="Fairfax">Fairfax</option>
		<option value="Fairfax Station">Fairfax Station</option>
	</select>
    <select id="zipcode" title="Zip Code" name="zipcode" onchange="onZipChanged('zipcode')">
		<option value="20120">20120</option>
		<option value="20121">20121</option>
		<option value="20124">20124</option>
		<option value="20151">20151</option>
		<option value="22033">22033</option>
		<option value="22039">22039</option>
	</select>
	<input id="email" title="E-mail address" name="email" type="email" size="30" placeholder="email address">
  </fieldset>
  <br>
  <fieldset>
  <legend class="major">Delivery Address: Update address that ONC will use for gift delivery</legend>
	<input id="checkbox" type="checkbox" id="sameaddress" title="Uncheck to edit HoH or Delivery address" onclick="sameAddressClicked(this)">Check if same as HOH address above, otherwise complete:
	<input id="delhousenum" title="Delivery House #" name="delhousenum" type="text" size="8" placeholder="House #" onchange="verifyDeliveryAddress()" autocomplete="off" required>
    <input id="delstreet" title="Delivery Street Name" name="delstreet" type="text" size="20" placeholder="Street Name" onchange="verifyDeliveryAddress()" autocomplete="off" required>
    <input id="delunit" title="Deleivery Apt. or Unit #" name="delunit" type="text" size="8" placeholder="Apt #" onchange="verifyDeliveryAddress()" autocomplete="off">
    <select id="delcity" title="Delivery City" name="delcity" onchange="cityChanged('delcity')">
		<option value="Centreville">Centreville</option>
		<option value="Chantilly">Chantilly</option>
		<option value="Clifton">Clifton</option>
		<option value="Fairfax">Fairfax</option>
		<option value="Fairfax Station">Fairfax Station</option>
	</select>	
    <select id="delzipcode" title="Deleivery Zip Code" name="delzipcode" onchange="onZipChanged('delzipcode')">
		<option value="20120">20120</option>
		<option value="20121">20121</option>
		<option value="20124">20124</option>
		<option value="20151">20151</option>
		<option value="22033">22033</option>
		<option value="22039">22039</option>
	</select>
  </fieldset>
  <br>
   <fieldset>
  <legend class="major">Meal Assistance Request Status</legend>
 	<label for='mealstatus'>Status:</label>
	<input id='mealstatus' type="text" size="14" title="Status of meal request" disabled>
	<label for='mealtype'>Requested For:</label>
    <select id="mealtype" name="mealtype" style="width: 136px" title="For which holidays does the family need meal assistance: Thanksgiving, December or Both?" disabled>
		<option value="No Assistance Rqrd">No Assistance Rqrd</option>
		<option value="Thanksgiving">Thanksgiving</option>
		<option value="December">December</option>
		<option value="Both">Both</option>
	</select>
	<label for='dietres'>Restrictions:</label>
	<input id="dietres" type="text" name="dietres" size="58" placeholder="Describe any dietary restrictions" title="Describe any family dietary restrictions" disabled>
  </fieldset>
  <br>
  <fieldset>
   <legend class="major">Family Details: Update details (if any) about family you think ONC should know</legend>
	<input id="detail" type="text" name="detail" size="128" placeholder="Details about family ONC should know" title="Provide ONC with information about the family you feel is important">
  </fieldset>
  <br>
  <div>
  	<span id="errormessage"></span>
  	<span id="submitspan">
  	  <label for="submit">Please check that all fields are complete prior to submission: </label>
  	  <input id="submit" type="submit" value="Submit Update to ONC" style="background-color: #336699; color: #ffffff;" title="Click to sumbit family to ONC">
  	</span>
  </div>
</form>
</body>
</html>   